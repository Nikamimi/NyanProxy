{% extends "admin/base.html" %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="user-management">
    <div class="header-actions">
        <h1>User Management</h1>
        <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary">Create New User</a>
    </div>

    <div class="filters">
        <form method="GET" action="{{ url_for('admin.list_users') }}">
            <div class="filter-row">
                <input type="text" name="search" placeholder="Search users..." value="{{ request.args.get('search', '') }}">
                <select name="type">
                    <option value="">All Types</option>
                    <option value="normal" {{ 'selected' if request.args.get('type') == 'normal' }}>Normal</option>
                    <option value="special" {{ 'selected' if request.args.get('type') == 'special' }}>Special</option>
                    <option value="temporary" {{ 'selected' if request.args.get('type') == 'temporary' }}>Temporary</option>
                </select>
                <select name="limit">
                    <option value="25" {{ 'selected' if request.args.get('limit') == '25' }}>25 per page</option>
                    <option value="50" {{ 'selected' if request.args.get('limit') == '50' }}>50 per page</option>
                    <option value="100" {{ 'selected' if request.args.get('limit') == '100' }}>100 per page</option>
                </select>
                <button type="submit">Filter</button>
            </div>
        </form>
    </div>

    <div class="users-table">
        <table>
            <thead>
                <tr>
                    <th>Token</th>
                    <th>Nickname</th>
                    <th>Type</th>
                    <th>Created</th>
                    <th>Status</th>
                    <th>Usage</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for user_data in users %}
                {% set user = user_data.user %}
                {% set stats = user_data.stats %}
                <tr class="{{ 'disabled' if user.disabled_at else '' }}">
                    <td>
                        <code>{{ user.token[:8] }}...</code>
                    </td>
                    <td>{{ user.nickname or 'N/A' }}</td>
                    <td>
                        <span class="badge badge-{{ user.type.value }}">{{ user.type.value }}</span>
                    </td>
                    <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                    <td>
                        {% if user.disabled_at %}
                            <span class="status-disabled">Disabled</span>
                        {% else %}
                            <span class="status-active">Active</span>
                        {% endif %}
                    </td>
                    <td>
                        <div class="usage-info">
                            <div>{{ stats.total_tokens }} tokens</div>
                            <div>{{ stats.total_requests }} requests</div>
                            <div>{{ stats.ip_count }} IPs</div>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{{ url_for('admin.view_user', token=user.token) }}" class="btn btn-sm btn-info">View</a>
                            <a href="{{ url_for('admin.edit_user', token=user.token) }}" class="btn btn-sm btn-secondary">Edit</a>
                            {% if user.disabled_at %}
                                <button class="btn btn-sm btn-success" onclick="enableUser('{{ user.token }}')">Enable</button>
                            {% else %}
                                <button class="btn btn-sm btn-warning" onclick="disableUser('{{ user.token }}')">Disable</button>
                            {% endif %}
                            <button class="btn btn-sm btn-danger" onclick="deleteUser('{{ user.token }}')">Delete</button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="pagination">
        {% if pagination.page > 1 %}
            <a href="{{ url_for('admin.list_users', page=pagination.page-1, **request.args) }}" class="btn btn-sm">Previous</a>
        {% endif %}
        
        <span class="page-info">
            Page {{ pagination.page }} of {{ (pagination.total + pagination.limit - 1) // pagination.limit }}
            ({{ pagination.total }} total users)
        </span>
        
        {% if pagination.has_next %}
            <a href="{{ url_for('admin.list_users', page=pagination.page+1, **request.args) }}" class="btn btn-sm">Next</a>
        {% endif %}
    </div>
</div>

<style>
    .header-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .filters {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    .filter-row {
        display: flex;
        gap: 10px;
        align-items: center;
    }
    .filter-row input, .filter-row select {
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 3px;
    }
    .users-table table {
        width: 100%;
        border-collapse: collapse;
    }
    .users-table th, .users-table td {
        padding: 10px;
        border: 1px solid #dee2e6;
        text-align: left;
    }
    .users-table th {
        background-color: #f8f9fa;
    }
    .users-table tr.disabled {
        opacity: 0.6;
        background-color: #f8f8f8;
    }
    .badge {
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.8em;
    }
    .badge-normal { background-color: #007bff; color: white; }
    .badge-special { background-color: #28a745; color: white; }
    .badge-temporary { background-color: #ffc107; color: black; }
    .status-active { color: #28a745; }
    .status-disabled { color: #dc3545; }
    .usage-info {
        font-size: 0.9em;
    }
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    .btn-sm {
        padding: 5px 10px;
        font-size: 0.8em;
    }
    .btn-info { background-color: #17a2b8; color: white; }
    .btn-warning { background-color: #ffc107; color: black; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-success { background-color: #28a745; color: white; }
    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 20px;
        margin-top: 20px;
    }
    .page-info {
        font-size: 0.9em;
        color: #666;
    }
</style>

<script>
function enableUser(token) {
    if (confirm('Are you sure you want to enable this user?')) {
        fetch(`/admin/users/${token}/enable`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function disableUser(token) {
    const reason = prompt('Reason for disabling user:');
    if (reason) {
        fetch(`/admin/users/${token}/disable`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}

function deleteUser(token) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        fetch(`/admin/users/${token}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}