{% extends "admin/base.html" %}

{% block title %}Admin Dashboard{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>{{ config.brand_emoji }} Admin Dashboard</h1>
    </div>

    <!-- Authentication Configuration Section -->
    <div class="config-section">
        <h2>Authentication Configuration</h2>
        <div class="config-content">
            <div class="config-item">
                <strong>Mode:</strong> {{ auth_config.mode }}
            </div>
            <div class="config-item">
                <strong>User Token Mode:</strong> {{ 'Enabled' if auth_config.mode == 'user_token' else 'Disabled' }}
            </div>
            <div class="config-item">
                <strong>Proxy Key Mode:</strong> {{ 'Enabled' if auth_config.mode == 'proxy_key' else 'Disabled' }}
            </div>
            <div class="config-item">
                <strong>Rate Limiting:</strong> {{ 'Enabled' if auth_config.rate_limit_enabled else 'Disabled' }}
            </div>
            <div class="config-item">
                <strong>Firebase Connected:</strong> {{ 'Yes' if firebase_connected else 'No' }}
            </div>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-label">Total Users</div>
            <div class="stat-value">{{ stats.total_users }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Active Users</div>
            <div class="stat-value">{{ stats.active_users }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Disabled Users</div>
            <div class="stat-value">{{ stats.disabled_users }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Total Requests</div>
            <div class="stat-value">{{ stats.usage_stats.total_requests or 0 }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Total Tokens</div>
            <div class="stat-value">{{ stats.usage_stats.total_tokens or 0 }}</div>
        </div>
        <div class="stat-box">
            <div class="stat-label">Total Cost</div>
            <div class="stat-value">${{ "%.2f"|format(stats.usage_stats.total_cost or 0) }}</div>
        </div>
    </div>

    <!-- Conversation Logging Section -->
    <div class="config-section">
        <h2>üó£Ô∏è Conversation Logging</h2>
        <div class="logging-controls">
            <div class="logging-status">
                <div class="status-item">
                    <label class="status-label">Logging Status:</label>
                    <span class="status-indicator" id="loggingStatus">Loading...</span>
                </div>
                <div class="status-item">
                    <label class="status-label">Google Sheets:</label>
                    <span class="status-indicator" id="sheetsStatus">Loading...</span>
                </div>
                <div class="status-item">
                    <label class="status-label">Queue Size:</label>
                    <span class="status-value" id="queueSize">Loading...</span>
                </div>
                <div class="status-item">
                    <label class="status-label">Total Logged:</label>
                    <span class="status-value" id="totalLogged">Loading...</span>
                </div>
            </div>
            
            <div class="logging-settings">
                <div class="setting-group">
                    <label class="toggle-switch">
                        <input type="checkbox" id="loggingEnabled" onchange="toggleLogging()">
                        <span class="slider"></span>
                        <span class="toggle-label">Enable Conversation Logging</span>
                    </label>
                </div>
                
                <div class="setting-group" id="loggingOptions" style="display: none;">
                    <label class="toggle-switch">
                        <input type="checkbox" id="logInput" onchange="updateLoggingSettings()">
                        <span class="slider"></span>
                        <span class="toggle-label">Log User Inputs</span>
                    </label>
                    
                    <label class="toggle-switch">
                        <input type="checkbox" id="logOutput" onchange="updateLoggingSettings()">
                        <span class="slider"></span>
                        <span class="toggle-label">Log Model Outputs</span>
                    </label>
                    
                    <div class="input-group">
                        <label for="maxInputLength">Last # of characters:</label>
                        <input type="number" id="maxInputLength" placeholder="Leave blank for unlimited" min="1" max="10000" step="100" onchange="updateLoggingSettings()">
                    </div>
                    
                </div>
            </div>
            
            <div class="logging-actions">
                <button class="action-btn secondary" onclick="refreshLoggingStats()">üîÑ Refresh Stats</button>
                <button class="action-btn secondary" onclick="viewLoggingLogs()">üìã View Logs</button>
                <button class="action-btn primary" onclick="openGoogleSheets()">üìä Open Google Sheets</button>
                <button class="action-btn warning" onclick="configureGoogleSheets()" style="font-size: 0.9em;">‚öôÔ∏è Configure Sheets</button>
                <button class="action-btn secondary" onclick="debugLoggingConfig()" style="font-size: 0.8em;">üîç Debug Config</button>
                <button class="action-btn secondary" onclick="forceSaveConfig()" style="font-size: 0.8em;">üíæ Force Save</button>
                <button class="action-btn secondary" onclick="testGoogleSheetsConfig()" style="font-size: 0.7em;">üß™ Test Sheets</button>
                <button class="action-btn secondary" onclick="checkDependencies()" style="font-size: 0.7em;">üì¶ Check Deps</button>
            </div>
        </div>
    </div>

    <!-- System Health Section -->
    <div class="config-section">
        <h2>üîß System Health & Performance</h2>
        <div class="system-health-grid">
            <div class="health-box" id="uptimeBox">
                <div class="health-label">Server Uptime</div>
                <div class="health-value" id="uptimeValue">Loading...</div>
            </div>
            <div class="health-box" id="memoryBox">
                <div class="health-label">Memory Usage</div>
                <div class="health-value" id="memoryValue">Loading...</div>
            </div>
            <div class="health-box" id="threadBox">
                <div class="health-label">Thread Count</div>
                <div class="health-value" id="threadValue">Loading...</div>
            </div>
            <div class="health-box" id="cpuBox">
                <div class="health-label">CPU Usage</div>
                <div class="health-value" id="cpuValue">Loading...</div>
            </div>
            <div class="health-box" id="restartsBox">
                <div class="health-label">Restarts</div>
                <div class="health-value" id="restartsValue">Loading...</div>
            </div>
            <div class="health-box" id="responseBox">
                <div class="health-label">Avg Response</div>
                <div class="health-value" id="responseValue">Loading...</div>
            </div>
        </div>
        
        <!-- System Actions -->
        <div class="system-actions">
            <button class="action-btn secondary" onclick="refreshSystemHealth()">üîÑ Refresh</button>
            <button class="action-btn warning" onclick="forceGarbageCollection()">üßπ Force GC</button>
            <button class="action-btn secondary" onclick="viewSystemLogs()">üìã View Logs</button>
            <button class="action-btn secondary" onclick="testHealthEndpoint()" style="font-size: 0.8em;">üîç Test API</button>
        </div>
        
        <!-- System Recommendations -->
        <div id="systemRecommendations" class="recommendations" style="display: none;">
            <h4>‚ö†Ô∏è System Recommendations:</h4>
            <ul id="recommendationsList"></ul>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-section">
        <button class="action-btn primary" onclick="window.location.href='{{ url_for('admin.create_user') }}'">Create User</button>
        <button class="action-btn secondary" onclick="refreshQuotas()">Refresh All Quotas</button>
        <button class="action-btn secondary" onclick="refreshUsers()">Refresh Users</button>
        <button class="action-btn warning" onclick="exportUsers()">Export Users</button>
    </div>

    <!-- Users Table -->
    <div class="users-section">
        <h2>Users</h2>
        <div class="table-container">
            <table class="users-table">
                <thead>
                    <tr>
                        <th>API Token</th>
                        <th>Type</th>
                        <th>Nickname</th>
                        <th>Status</th>
                        <th>IPs</th>
                        <th>Requests</th>
                        <th>Token Usage</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% if stats.total_users == 0 %}
                    <tr>
                        <td colspan="8" style="text-align: center; color: #666; padding: 20px;">
                            No users found. <a href="{{ url_for('admin.create_user') }}">Create your first user</a>
                        </td>
                    </tr>
                    {% else %}
                        {% for user_data in users_data %}
                        {% set user = user_data.user %}
                        {% set stats = user_data.stats %}
                        <tr class="{{ 'disabled' if user.disabled_at else '' }}">
                            <td>
                                <code>{{ user.token[:8] }}...</code>
                            </td>
                            <td>
                                <span class="badge badge-{{ user.type.value }}">{{ user.type.value }}</span>
                            </td>
                            <td>{{ user.nickname or 'N/A' }}</td>
                            <td>
                                {% if user.disabled_at %}
                                    <span class="status-disabled">Disabled</span>
                                {% else %}
                                    <span class="status-active">Active</span>
                                {% endif %}
                            </td>
                            <td>{{ stats.ip_count }}</td>
                            <td>{{ stats.total_requests }}</td>
                            <td>{{ stats.total_tokens }}</td>
                            <td>
                                <div class="action-buttons">
                                    <a href="{{ url_for('admin.view_user', token=user.token) }}" class="btn btn-sm btn-info">View</a>
                                    <a href="{{ url_for('admin.edit_user', token=user.token) }}" class="btn btn-sm btn-secondary">Edit</a>
                                    {% if user.disabled_at %}
                                        <button class="btn btn-sm btn-success" onclick="enableUser('{{ user.token }}')">Enable</button>
                                    {% else %}
                                        <button class="btn btn-sm btn-warning" onclick="disableUser('{{ user.token }}')">Disable</button>
                                    {% endif %}
                                    <button class="btn btn-sm btn-danger" onclick="deleteUser('{{ user.token }}')">Delete</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if users_data|length < stats.total_users %}
                        <tr>
                            <td colspan="8" style="text-align: center; color: #666; padding: 20px;">
                                <a href="{{ url_for('admin.list_users') }}">View all {{ stats.total_users }} users ‚Üí</a>
                            </td>
                        </tr>
                        {% endif %}
                    {% endif %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<style>
    .dashboard-container {
        max-width: 1400px;
        width: 100%;
        margin: 0 auto;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .dashboard-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .dashboard-header h1 {
        color: #333;
        font-size: 2em;
        margin: 0;
        font-weight: 500;
    }

    /* Authentication Configuration Section */
    .config-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 25px;
        width: 100%;
        max-width: 1200px;
    }

    .config-section h2 {
        color: #495057;
        font-size: 1.2em;
        margin: 0 0 15px 0;
        font-weight: 600;
    }

    .config-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 10px;
    }

    .config-item {
        font-size: 0.9em;
        color: #495057;
    }

    .config-item strong {
        color: #212529;
    }

    /* Statistics Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
        border: 2px solid #dc3545;
        border-radius: 8px;
        padding: 20px;
        background: white;
        width: 100%;
        max-width: 1200px;
    }

    .stat-box {
        text-align: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .stat-label {
        font-size: 0.9em;
        color: #6c757d;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #007bff;
        margin: 0;
    }

    /* Action Buttons */
    .action-section {
        display: flex;
        gap: 10px;
        margin-bottom: 25px;
        flex-wrap: wrap;
        width: 100%;
        max-width: 1200px;
        justify-content: center;
    }

    .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        font-size: 0.9em;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-block;
    }

    .action-btn.primary {
        background-color: #007bff;
        color: white;
    }

    .action-btn.primary:hover {
        background-color: #0056b3;
    }

    .action-btn.secondary {
        background-color: #6c757d;
        color: white;
    }

    .action-btn.secondary:hover {
        background-color: #545b62;
    }

    .action-btn.warning {
        background-color: #ffc107;
        color: #212529;
    }

    .action-btn.warning:hover {
        background-color: #e0a800;
    }

    /* Users Section */
    .users-section {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        overflow: hidden;
        width: 100%;
        max-width: 1200px;
    }

    .users-section h2 {
        background: #f8f9fa;
        padding: 15px 20px;
        margin: 0;
        font-size: 1.1em;
        font-weight: 600;
        color: #495057;
        border-bottom: 1px solid #e9ecef;
    }

    .table-container {
        overflow-x: auto;
    }

    .users-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9em;
    }

    .users-table th {
        background: #f8f9fa;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 1px solid #e9ecef;
    }

    .users-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f8f9fa;
        color: #495057;
    }

    .users-table tr:hover {
        background-color: #f8f9fa;
    }

    .users-table a {
        color: #007bff;
        text-decoration: none;
    }

    .users-table a:hover {
        text-decoration: underline;
    }

    /* User badges and status */
    .badge {
        padding: 3px 8px;
        border-radius: 3px;
        font-size: 0.8em;
        font-weight: bold;
    }
    .badge-normal { background-color: #007bff; color: white; }
    .badge-special { background-color: #28a745; color: white; }
    .badge-temporary { background-color: #ffc107; color: black; }
    
    .status-active { 
        color: #28a745; 
        font-weight: bold;
    }
    .status-disabled { 
        color: #dc3545; 
        font-weight: bold;
    }
    
    /* Action buttons */
    .action-buttons {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }
    
    .btn {
        padding: 6px 12px;
        border: none;
        border-radius: 4px;
        font-size: 0.9em;
        cursor: pointer;
        transition: background-color 0.2s;
        text-decoration: none;
        display: inline-block;
    }
    
    .btn-sm {
        padding: 4px 8px;
        font-size: 0.8em;
    }
    
    .btn-info { background-color: #17a2b8; color: white; }
    .btn-info:hover { background-color: #138496; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-secondary:hover { background-color: #545b62; }
    .btn-warning { background-color: #ffc107; color: black; }
    .btn-warning:hover { background-color: #e0a800; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-danger:hover { background-color: #c82333; }
    .btn-success { background-color: #28a745; color: white; }
    .btn-success:hover { background-color: #218838; }
    
    /* Disabled row styling */
    .users-table tr.disabled {
        opacity: 0.6;
        background-color: #f8f9fa;
    }

    /* System Health Styles */
    .system-health-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
    }

    .health-box {
        text-align: center;
        padding: 15px;
        background: #fff;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .health-box.status-good {
        border-left: 4px solid #28a745;
        background: #f8fff9;
    }

    .health-box.status-warning {
        border-left: 4px solid #ffc107;
        background: #fffdf5;
    }

    .health-box.status-error {
        border-left: 4px solid #dc3545;
        background: #fff5f5;
    }

    .health-label {
        font-size: 0.85em;
        color: #6c757d;
        margin-bottom: 8px;
        font-weight: 500;
    }

    .health-value {
        font-size: 1.4em;
        font-weight: bold;
        color: #495057;
    }

    .system-actions {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
        justify-content: center;
    }

    .recommendations {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 6px;
        padding: 15px;
        margin-top: 15px;
    }

    .recommendations h4 {
        margin: 0 0 10px 0;
        color: #856404;
        font-size: 1em;
    }

    .recommendations ul {
        margin: 0;
        padding-left: 20px;
        color: #856404;
    }

    .recommendations li {
        margin-bottom: 5px;
    }

    /* Conversation Logging Styles */
    .logging-controls {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .logging-status {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .status-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
    }

    .status-label {
        font-size: 0.85em;
        color: #6c757d;
        margin-bottom: 5px;
        font-weight: 500;
    }

    .status-indicator {
        font-weight: bold;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.9em;
    }

    .status-indicator.enabled {
        background: #d4edda;
        color: #155724;
    }

    .status-indicator.disabled {
        background: #f8d7da;
        color: #721c24;
    }

    .status-indicator.connected {
        background: #d1ecf1;
        color: #0c5460;
    }

    .status-indicator.disconnected {
        background: #f5c6cb;
        color: #721c24;
    }

    .status-value {
        font-weight: bold;
        color: #495057;
        font-size: 1.2em;
    }

    .logging-settings {
        display: flex;
        flex-direction: column;
        gap: 15px;
        padding: 15px;
        background: white;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    .setting-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    /* Toggle Switch Styles */
    .toggle-switch {
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-size: 0.95em;
    }

    .toggle-switch input[type="checkbox"] {
        display: none;
    }

    .slider {
        width: 50px;
        height: 24px;
        background-color: #ccc;
        border-radius: 24px;
        position: relative;
        transition: background-color 0.3s;
    }

    .slider:before {
        content: "";
        position: absolute;
        top: 2px;
        left: 2px;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background-color: white;
        transition: transform 0.3s;
    }

    .toggle-switch input:checked + .slider {
        background-color: #007bff;
    }

    .toggle-switch input:checked + .slider:before {
        transform: translateX(26px);
    }

    .toggle-label {
        font-weight: 500;
        color: #495057;
    }

    .input-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .input-group label {
        font-size: 0.9em;
        color: #6c757d;
        min-width: 120px;
    }

    .input-group input[type="number"] {
        width: 100px;
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 0.9em;
    }

    .logging-actions {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #dee2e6;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .dashboard-container {
            padding: 15px;
        }
        
        .config-content {
            grid-template-columns: 1fr;
        }
        
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .action-section {
            flex-direction: column;
        }
        
        .action-btn {
            width: 100%;
            text-align: center;
        }
    }

    @media (max-width: 480px) {
        .stats-grid {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
function refreshQuotas() {
    alert('Refresh All Quotas functionality - to be implemented');
}

function refreshUsers() {
    window.location.reload();
}

function exportUsers() {
    alert('Export Users functionality - to be implemented');
}

// User management functions
function enableUser(token) {
    if (confirm('Are you sure you want to enable this user?')) {
        $.post(`/admin/users/${token}/enable`, {})
        .done(function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .fail(function() {
            alert('Error: Failed to enable user');
        });
    }
}

function disableUser(token) {
    const reason = prompt('Reason for disabling user:');
    if (reason) {
        $.post(`/admin/users/${token}/disable`, {
            reason: reason
        })
        .done(function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .fail(function() {
            alert('Error: Failed to disable user');
        });
    }
}

function deleteUser(token) {
    if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
        $.ajax({
            url: `/admin/users/${token}`,
            type: 'DELETE'
        })
        .done(function(data) {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .fail(function() {
            alert('Error: Failed to delete user');
        });
    }
}

// System Health Functions
async function loadSystemHealth() {
    console.log('üîÑ Loading system health...');
    try {
        const response = await fetch('/api/system/health');
        console.log('üìä System health response status:', response.status);
        
        if (response.ok) {
            const health = await response.json();
            console.log('üìä System health data:', health);
            updateSystemHealthDisplay(health);
        } else {
            const errorText = await response.text();
            console.error('Failed to load system health:', response.status, errorText);
            showHealthError('HTTP ' + response.status);
        }
    } catch (error) {
        console.error('Error loading system health:', error);
        showHealthError('Network Error: ' + error.message);
    }
}

function updateSystemHealthDisplay(health) {
    const metrics = health.metrics;
    const systemStats = metrics.system_stats;
    const threadStats = metrics.thread_stats;

    // Update uptime
    const uptimeHours = (metrics.uptime_seconds / 3600).toFixed(1);
    updateHealthBox('uptimeBox', 'uptimeValue', `${uptimeHours}h`, 'good');

    // Update memory usage
    const memoryMB = systemStats.memory_mb;
    const memoryStatus = memoryMB > 400 ? 'error' : (memoryMB > 250 ? 'warning' : 'good');
    updateHealthBox('memoryBox', 'memoryValue', `${memoryMB} MB`, memoryStatus);

    // Update thread count
    const threadCount = systemStats.thread_count;
    const threadStatus = threadCount > 50 ? 'error' : (threadCount > 30 ? 'warning' : 'good');
    updateHealthBox('threadBox', 'threadValue', threadCount.toString(), threadStatus);

    // Update CPU usage
    const cpuPercent = systemStats.cpu_percent;
    const cpuStatus = cpuPercent > 80 ? 'error' : (cpuPercent > 60 ? 'warning' : 'good');
    updateHealthBox('cpuBox', 'cpuValue', `${cpuPercent}%`, cpuStatus);

    // Update restart count
    const restarts = metrics.restart_count;
    const restartStatus = restarts > 5 ? 'warning' : (restarts > 10 ? 'error' : 'good');
    updateHealthBox('restartsBox', 'restartsValue', restarts.toString(), restartStatus);

    // Update response time
    const avgResponse = metrics.average_response_time;
    const responseStatus = avgResponse > 5 ? 'error' : (avgResponse > 2 ? 'warning' : 'good');
    updateHealthBox('responseBox', 'responseValue', `${avgResponse.toFixed(2)}s`, responseStatus);

    // Show recommendations if any
    if (health.recommendations && health.recommendations.length > 0) {
        const recommendationsDiv = document.getElementById('systemRecommendations');
        const recommendationsList = document.getElementById('recommendationsList');
        
        recommendationsList.innerHTML = '';
        health.recommendations.forEach(rec => {
            const li = document.createElement('li');
            li.textContent = rec;
            recommendationsList.appendChild(li);
        });
        
        recommendationsDiv.style.display = 'block';
    } else {
        document.getElementById('systemRecommendations').style.display = 'none';
    }
}

function updateHealthBox(boxId, valueId, value, status) {
    const box = document.getElementById(boxId);
    const valueElement = document.getElementById(valueId);
    
    // Remove existing status classes
    box.classList.remove('status-good', 'status-warning', 'status-error');
    
    // Add new status class
    if (status) {
        box.classList.add(`status-${status}`);
    }
    
    // Update value
    valueElement.textContent = value;
}

function showHealthError(errorMessage = 'Error') {
    console.log('‚ùå Showing health error:', errorMessage);
    const healthValues = ['uptimeValue', 'memoryValue', 'threadValue', 'cpuValue', 'restartsValue', 'responseValue'];
    const healthBoxes = ['uptimeBox', 'memoryBox', 'threadBox', 'cpuBox', 'restartsBox', 'responseBox'];
    
    healthValues.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            element.textContent = errorMessage.length > 15 ? 'Error' : errorMessage;
        }
    });
    
    // Mark all boxes as error state
    healthBoxes.forEach(id => {
        const box = document.getElementById(id);
        if (box) {
            box.classList.remove('status-good', 'status-warning');
            box.classList.add('status-error');
        }
    });
}

function refreshSystemHealth() {
    loadSystemHealth();
}

async function forceGarbageCollection() {
    try {
        const response = await fetch('/api/system/gc', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            alert(`Garbage collection completed! ${result.objects_collected} objects collected.`);
            // Refresh health data after GC
            setTimeout(loadSystemHealth, 1000);
        } else {
            const errorText = await response.text();
            console.error('GC failed:', response.status, errorText);
            alert('Failed to force garbage collection: HTTP ' + response.status);
        }
    } catch (error) {
        console.error('Error forcing garbage collection:', error);
        alert('Error forcing garbage collection: ' + error.message);
    }
}

function viewSystemLogs() {
    window.open('/api/system/health', '_blank');
}

async function testHealthEndpoint() {
    console.log('üîç Testing health endpoint...');
    try {
        const response = await fetch('/api/system/health');
        console.log('üîç Test response:', response);
        
        const responseText = await response.text();
        console.log('üîç Response text:', responseText);
        
        if (response.ok) {
            try {
                const data = JSON.parse(responseText);
                alert('‚úÖ Health endpoint working!\nStatus: ' + response.status + '\nUptime: ' + (data.uptime_seconds/3600).toFixed(1) + 'h');
                loadSystemHealth(); // Try loading again
            } catch (e) {
                alert('‚ö†Ô∏è Health endpoint returns invalid JSON:\n' + responseText.substring(0, 200));
            }
        } else {
            alert('‚ùå Health endpoint error!\nStatus: ' + response.status + '\nResponse: ' + responseText.substring(0, 200));
        }
    } catch (error) {
        console.error('üîç Test error:', error);
        alert('‚ùå Network error testing health endpoint:\n' + error.message);
    }
}

// Initialize system health monitoring after everything is loaded
function initializeSystemHealth() {
    if (window.healthMonitoringStarted) {
        console.log('üîß Health monitoring already started, skipping...');
        return;
    }
    
    window.healthMonitoringStarted = true;
    console.log('üîß Initializing system health monitoring...');
    
    // Load immediately with a delay to ensure everything is ready
    setTimeout(function() {
        console.log('üîÑ Loading initial system health data...');
        loadSystemHealth();
    }, 1500); // Longer delay to ensure admin.js is fully loaded
    
    // Set up auto-refresh every 30 seconds
    setInterval(function() {
        console.log('üîÑ Auto-refreshing system health...');
        loadSystemHealth();
    }, 30000);
}

// Check if jQuery is available, if not use vanilla JS
function initHealthMonitoringWhenReady() {
    if (typeof $ !== 'undefined' && $.fn) {
        console.log('‚úÖ jQuery is available, using jQuery initialization');
        $(document).ready(function() {
            console.log('üìÑ Dashboard DOM ready with jQuery, waiting for complete page load...');
            
            $(window).on('load', function() {
                console.log('üìÑ Page fully loaded, initializing health monitoring...');
                setTimeout(initializeSystemHealth, 500);
            });
            
            // Fallback timeout
            setTimeout(function() {
                console.log('üìÑ jQuery fallback initialization of health monitoring...');
                if (!window.healthMonitoringStarted) {
                    initializeSystemHealth();
                }
            }, 3000);
        });
    } else {
        console.log('‚ö†Ô∏è jQuery not available, using vanilla JS initialization');
        
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                console.log('üìÑ DOM ready (vanilla JS), waiting for window load...');
                window.addEventListener('load', function() {
                    console.log('üìÑ Window loaded (vanilla JS), initializing health monitoring...');
                    setTimeout(initializeSystemHealth, 500);
                });
                
                // Fallback timeout
                setTimeout(function() {
                    console.log('üìÑ Vanilla JS fallback initialization of health monitoring...');
                    if (!window.healthMonitoringStarted) {
                        initializeSystemHealth();
                    }
                }, 3000);
            });
        } else {
            // DOM already loaded
            console.log('üìÑ DOM already ready (vanilla JS), initializing immediately...');
            setTimeout(initializeSystemHealth, 1000);
        }
    }
}

// Start initialization
initHealthMonitoringWhenReady();

// Conversation Logging Functions
let currentSpreadsheetId = null;

async function loadLoggingStats() {
    console.log('üó£Ô∏è Loading conversation logging stats...');
    try {
        const response = await fetch('/api/admin/logging/stats');
        console.log('üìä Logging stats response status:', response.status);
        
        if (response.ok) {
            const stats = await response.json();
            console.log('üìä Logging stats data:', stats);
            updateLoggingDisplay(stats);
        } else {
            const errorText = await response.text();
            console.error('Failed to load logging stats:', response.status, errorText);
            showLoggingError('HTTP ' + response.status);
        }
    } catch (error) {
        console.error('Error loading logging stats:', error);
        showLoggingError('Network Error: ' + error.message);
    }
}

function updateLoggingDisplay(stats) {
    // Update status indicators
    const loggingStatus = document.getElementById('loggingStatus');
    const sheetsStatus = document.getElementById('sheetsStatus');
    const queueSize = document.getElementById('queueSize');
    const totalLogged = document.getElementById('totalLogged');
    
    // Update logging status
    loggingStatus.textContent = stats.enabled ? 'Enabled' : 'Disabled';
    loggingStatus.className = `status-indicator ${stats.enabled ? 'enabled' : 'disabled'}`;
    
    // Update Google Sheets status
    sheetsStatus.textContent = stats.sheets_connected ? 'Connected' : 'Disconnected';
    sheetsStatus.className = `status-indicator ${stats.sheets_connected ? 'connected' : 'disconnected'}`;
    
    // Update queue and total stats
    queueSize.textContent = stats.queue_size || 0;
    totalLogged.textContent = (stats.total_logged || 0).toLocaleString();
    
    // Update form controls
    const loggingEnabled = document.getElementById('loggingEnabled');
    const logInput = document.getElementById('logInput');
    const logOutput = document.getElementById('logOutput');
    const maxInputLength = document.getElementById('maxInputLength');
    const loggingOptions = document.getElementById('loggingOptions');
    
    loggingEnabled.checked = stats.enabled;
    logInput.checked = stats.log_input;
    logOutput.checked = stats.log_output;
    maxInputLength.value = stats.last_number_of_chars || '';
    
    // Show/hide options based on enabled status
    loggingOptions.style.display = stats.enabled ? 'block' : 'none';
    
    console.log('üìä Logging display updated successfully');
}

function showLoggingError(errorMessage = 'Error') {
    console.log('‚ùå Showing logging error:', errorMessage);
    const statusElements = ['loggingStatus', 'sheetsStatus', 'queueSize', 'totalLogged'];
    
    statusElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            if (id.includes('Status')) {
                element.textContent = 'Error';
                element.className = 'status-indicator disabled';
            } else {
                element.textContent = errorMessage.length > 15 ? 'Error' : errorMessage;
            }
        }
    });
}

async function toggleLogging() {
    const enabled = document.getElementById('loggingEnabled').checked;
    console.log('üó£Ô∏è Toggling logging:', enabled);
    
    try {
        const response = await fetch('/api/admin/logging/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ enabled: enabled })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                console.log('‚úÖ Logging toggle successful');
                // Refresh stats to reflect changes
                setTimeout(loadLoggingStats, 1000);
            } else {
                alert('Failed to toggle logging: ' + (result.error || 'Unknown error'));
                // Revert checkbox
                document.getElementById('loggingEnabled').checked = !enabled;
            }
        } else {
            const errorText = await response.text();
            alert('Failed to toggle logging: HTTP ' + response.status + ' - ' + errorText);
            // Revert checkbox
            document.getElementById('loggingEnabled').checked = !enabled;
        }
    } catch (error) {
        console.error('Error toggling logging:', error);
        alert('Error toggling logging: ' + error.message);
        // Revert checkbox
        document.getElementById('loggingEnabled').checked = !enabled;
    }
}

async function updateLoggingSettings() {
    const settings = {
        log_input: document.getElementById('logInput').checked,
        log_output: document.getElementById('logOutput').checked,
        last_number_of_chars: parseInt(document.getElementById('maxInputLength').value) || null
    };
    
    console.log('üó£Ô∏è Updating logging settings:', settings);
    
    try {
        const response = await fetch('/api/admin/logging/settings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(settings)
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                console.log('‚úÖ Logging settings updated');
                showSuccessMessage('Logging settings updated');
            } else {
                alert('Failed to update settings: ' + (result.error || 'Unknown error'));
            }
        } else {
            const errorText = await response.text();
            alert('Failed to update settings: HTTP ' + response.status + ' - ' + errorText);
        }
    } catch (error) {
        console.error('Error updating logging settings:', error);
        alert('Error updating settings: ' + error.message);
    }
}

function refreshLoggingStats() {
    loadLoggingStats();
}

function viewLoggingLogs() {
    window.open('/api/admin/logging/stats', '_blank');
}

async function openGoogleSheets() {
    if (!currentSpreadsheetId) {
        // Try to get the spreadsheet ID from the server
        try {
            const response = await fetch('/api/admin/logging/config');
            if (response.ok) {
                const config = await response.json();
                currentSpreadsheetId = config.google_sheets?.spreadsheet_id;
            }
        } catch (error) {
            console.error('Failed to get spreadsheet ID:', error);
        }
    }
    
    if (currentSpreadsheetId) {
        const url = `https://docs.google.com/spreadsheets/d/${currentSpreadsheetId}/edit`;
        window.open(url, '_blank');
    } else {
        alert('Google Sheets not configured. Please configure Google Sheets first.');
        configureGoogleSheets();
    }
}

function configureGoogleSheets() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>üó£Ô∏è Configure Google Sheets Logging</h3>
            <div class="form-group">
                <label for="spreadsheetId">Google Sheets ID:</label>
                <input type="text" id="spreadsheetId" placeholder="Enter your Google Sheets ID" style="width: 100%; padding: 8px; margin: 8px 0;">
                <small>Find this in your Google Sheets URL: docs.google.com/spreadsheets/d/<strong>SHEET_ID</strong>/edit</small>
            </div>
            <div class="form-group">
                <label for="serviceAccountKey">Service Account JSON:</label>
                <textarea id="serviceAccountKey" placeholder="Paste your Google Service Account JSON key here" rows="8" style="width: 100%; padding: 8px; margin: 8px 0;"></textarea>
                <small>Generate this from Google Cloud Console > Service Accounts</small>
            </div>
            <div class="modal-actions">
                <button class="action-btn secondary" onclick="closeConfigModal()">Cancel</button>
                <button class="action-btn secondary" onclick="showServiceAccountEmail()" style="font-size: 0.8em;">üìß Show Email</button>
                <button class="action-btn warning" onclick="testGoogleSheetsConnection()">üß™ Test Connection</button>
                <button class="action-btn primary" onclick="saveGoogleSheetsConfig()">Save Configuration</button>
            </div>
        </div>
    `;
    
    // Add modal styles
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.5); z-index: 10000;
        display: flex; align-items: center; justify-content: center;
    `;
    
    const modalContent = modal.querySelector('.modal-content');
    modalContent.style.cssText = `
        background: white; padding: 30px; border-radius: 8px;
        max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;
    `;
    
    document.body.appendChild(modal);
}

function closeConfigModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

async function saveGoogleSheetsConfig() {
    const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
    const serviceAccountKey = document.getElementById('serviceAccountKey').value.trim();
    
    if (!spreadsheetId || !serviceAccountKey) {
        alert('Please fill in both the Spreadsheet ID and Service Account JSON');
        return;
    }
    
    try {
        // Validate JSON
        JSON.parse(serviceAccountKey);
    } catch (e) {
        alert('Invalid JSON in Service Account Key');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/logging/configure', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                google_sheets: {
                    spreadsheet_id: spreadsheetId,
                    service_account_key: serviceAccountKey
                }
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                currentSpreadsheetId = spreadsheetId;
                alert('Google Sheets configuration saved successfully!');
                closeConfigModal();
                // Refresh stats to show updated connection status
                setTimeout(loadLoggingStats, 1000);
            } else {
                alert('Failed to save configuration: ' + (result.error || 'Unknown error'));
            }
        } else {
            const errorText = await response.text();
            alert('Failed to save configuration: HTTP ' + response.status + ' - ' + errorText);
        }
    } catch (error) {
        console.error('Error saving configuration:', error);
        alert('Error saving configuration: ' + error.message);
    }
}

// Initialize conversation logging monitoring
function initializeLoggingMonitoring() {
    if (window.loggingMonitoringStarted) {
        console.log('üó£Ô∏è Logging monitoring already started, skipping...');
        return;
    }
    
    window.loggingMonitoringStarted = true;
    console.log('üó£Ô∏è Initializing conversation logging monitoring...');
    
    // Load immediately with a delay
    setTimeout(function() {
        console.log('üîÑ Loading initial logging stats...');
        loadLoggingStats();
    }, 2000);
    
    // Set up auto-refresh every 60 seconds for logging stats
    setInterval(function() {
        console.log('üîÑ Auto-refreshing logging stats...');
        loadLoggingStats();
    }, 60000);
}

function showSuccessMessage(message) {
    // Simple success feedback - could be enhanced with a proper notification system
    const tempAlert = document.createElement('div');
    tempAlert.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 9999;
        background: #d4edda; color: #155724; padding: 12px 20px;
        border: 1px solid #c3e6cb; border-radius: 6px;
        font-size: 14px; font-weight: 500;
    `;
    tempAlert.textContent = message;
    document.body.appendChild(tempAlert);
    
    setTimeout(() => {
        tempAlert.remove();
    }, 3000);
}

async function debugLoggingConfig() {
    try {
        const response = await fetch('/api/admin/logging/debug');
        if (response.ok) {
            const debugInfo = await response.json();
            
            let debugMessage = 'üîç Conversation Logging Debug Info:\n\n';
            debugMessage += `Firebase Connected: ${debugInfo.firebase_connected}\n`;
            debugMessage += `Config Key: ${debugInfo.config_key}\n`;
            debugMessage += `Raw Config Exists: ${debugInfo.raw_config_exists}\n`;
            debugMessage += `Raw Config Keys: ${debugInfo.raw_config_keys?.join(', ') || 'None'}\n`;
            debugMessage += `Logger Enabled: ${debugInfo.logger_enabled}\n`;
            debugMessage += `Sheets Logger Exists: ${debugInfo.sheets_logger_exists}\n`;
            debugMessage += `Sheets Connected: ${debugInfo.sheets_connected}\n\n`;
            
            if (debugInfo.google_sheets_debug) {
                const sheets = debugInfo.google_sheets_debug;
                debugMessage += 'üìä Google Sheets Debug:\n';
                debugMessage += `Has Spreadsheet ID: ${sheets.has_spreadsheet_id}\n`;
                debugMessage += `Spreadsheet ID Length: ${sheets.spreadsheet_id_length} chars\n`;
                debugMessage += `Has Service Account Key (base64): ${sheets.has_service_account_key_b64}\n`;
                debugMessage += `Service Account Key Length: ${sheets.service_account_key_b64_length} chars\n`;
                debugMessage += `Has Plain Service Account Key: ${sheets.has_plain_service_account_key}\n`;
                debugMessage += `Connected Status: ${sheets.connected_status}\n`;
            } else {
                debugMessage += 'üìä No Google Sheets config found in Firebase\n';
            }
            
            alert(debugMessage);
        } else {
            const errorText = await response.text();
            alert('Debug request failed: ' + response.status + ' - ' + errorText);
        }
    } catch (error) {
        console.error('Debug request error:', error);
        alert('Debug request error: ' + error.message);
    }
}

async function forceSaveConfig() {
    try {
        const response = await fetch('/api/admin/logging/save-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showSuccessMessage('Configuration forcefully saved to Firebase');
            } else {
                alert('Failed to save configuration: ' + (result.error || 'Unknown error'));
            }
        } else {
            const errorText = await response.text();
            alert('Failed to save configuration: HTTP ' + response.status + ' - ' + errorText);
        }
    } catch (error) {
        console.error('Force save error:', error);
        alert('Error saving configuration: ' + error.message);
    }
}

function showServiceAccountEmail() {
    const serviceAccountKey = document.getElementById('serviceAccountKey').value.trim();
    
    if (!serviceAccountKey) {
        alert('Please paste your Service Account JSON first');
        return;
    }
    
    try {
        const keyData = JSON.parse(serviceAccountKey);
        const email = keyData.client_email;
        const projectId = keyData.project_id;
        
        if (email) {
            let message = 'üìß SERVICE ACCOUNT EMAIL:\n\n';
            message += `${email}\n\n`;
            message += 'üìã COPY THIS EMAIL and follow these steps:\n\n';
            message += '1. üìä Open your Google Sheet in browser\n';
            message += '2. üîó Click "Share" button (top-right)\n';
            message += '3. ‚úâÔ∏è Paste this email address\n';
            message += '4. ‚öôÔ∏è Set permission to "Editor"\n';
            message += '5. üì§ Click "Send"\n';
            message += '6. üîÑ Come back and test connection\n\n';
            message += `Project: ${projectId || 'Unknown'}`;
            
            alert(message);
        } else {
            alert('‚ùå Could not find client_email in the JSON.\nPlease check your Service Account JSON format.');
        }
    } catch (e) {
        alert('‚ùå Invalid JSON format.\nPlease check your Service Account JSON.');
    }
}

async function testGoogleSheetsConnection() {
    const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
    const serviceAccountKey = document.getElementById('serviceAccountKey').value.trim();
    
    if (!spreadsheetId || !serviceAccountKey) {
        alert('Please fill in both the Spreadsheet ID and Service Account JSON before testing');
        return;
    }
    
    try {
        // Validate JSON first
        JSON.parse(serviceAccountKey);
    } catch (e) {
        alert('Invalid JSON in Service Account Key. Please check the format.');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/logging/test-sheets', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                spreadsheet_id: spreadsheetId,
                service_account_key: serviceAccountKey
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                let message = '‚úÖ Google Sheets Connection Successful!\n\n';
                message += `üìä Spreadsheet: ${result.spreadsheet_title}\n`;
                message += `üìã Worksheets: ${result.worksheet_count} (${result.worksheet_names.join(', ')})\n`;
                message += `üîê Service Account: ${result.service_account_email}\n\n`;
                message += 'You can now safely save this configuration.';
                alert(message);
            } else {
                let message = '‚ùå Google Sheets Connection Failed\n\n';
                message += `Error: ${result.error}\n\n`;
                
                if (result.error.includes('Spreadsheet not found') || result.error.includes('PermissionError')) {
                    message += 'SOLUTION - Follow these steps:\n\n';
                    message += '1. üìã COPY the service account email from your JSON:\n';
                    message += '   Look for "client_email" in your JSON file\n\n';
                    message += '2. üìä OPEN your Google Sheet in a browser\n\n';
                    message += '3. üîó CLICK the "Share" button (top-right)\n\n';
                    message += '4. ‚úâÔ∏è PASTE the service account email\n\n';
                    message += '5. ‚öôÔ∏è SET permissions to "Editor"\n\n';
                    message += '6. üì§ CLICK "Send" (no notification needed)\n\n';
                    message += '7. üîÑ TRY the test again\n\n';
                    message += 'The service account email should look like:\n';
                    message += 'your-service@your-project.iam.gserviceaccount.com';
                } else if (result.error.includes('Invalid JSON')) {
                    message += 'Please check your Service Account JSON format.';
                } else if (result.error.includes('Missing dependencies')) {
                    message += 'Google Sheets dependencies are not installed.\n';
                    message += 'Please install: pip install gspread google-auth';
                }
                
                alert(message);
            }
        } else {
            const errorText = await response.text();
            alert('Test request failed: HTTP ' + response.status + ' - ' + errorText);
        }
    } catch (error) {
        console.error('Test connection error:', error);
        alert('Test connection error: ' + error.message);
    }
}

async function testGoogleSheetsConfig() {
    try {
        // First, let's test with a simple configuration to see if it gets saved
        const testConfig = {
            enabled: false, // Keep logging disabled for testing
            google_sheets: {
                spreadsheet_id: "test_spreadsheet_id_12345",
                service_account_key: JSON.stringify({
                    "type": "service_account",
                    "project_id": "test-project",
                    "private_key_id": "test-key-id",
                    "private_key": "-----BEGIN PRIVATE KEY-----\nTEST_KEY\n-----END PRIVATE KEY-----\n",
                    "client_email": "test@test.iam.gserviceaccount.com",
                    "client_id": "test-client-id",
                    "auth_uri": "https://accounts.google.com/o/oauth2/auth",
                    "token_uri": "https://oauth2.googleapis.com/token"
                })
            }
        };
        
        console.log('üß™ Testing Google Sheets configuration with test data...');
        
        const response = await fetch('/api/admin/logging/configure', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(testConfig)
        });
        
        if (response.ok) {
            const result = await response.json();
            if (result.success) {
                showSuccessMessage('Test configuration sent successfully');
                
                // Wait a moment, then check debug info
                setTimeout(async () => {
                    const debugResponse = await fetch('/api/admin/logging/debug');
                    if (debugResponse.ok) {
                        const debugInfo = await debugResponse.json();
                        console.log('üß™ Debug info after test:', debugInfo);
                        
                        let message = 'üß™ Test Results:\n\n';
                        if (debugInfo.google_sheets_debug) {
                            const sheets = debugInfo.google_sheets_debug;
                            message += `‚úÖ Google Sheets config found in Firebase\n`;
                            message += `‚úÖ Has Spreadsheet ID: ${sheets.has_spreadsheet_id}\n`;
                            message += `‚úÖ Has Service Account Key: ${sheets.has_service_account_key_b64}\n`;
                            message += `üìè Key Length: ${sheets.service_account_key_b64_length} chars\n`;
                        } else {
                            message += `‚ùå No Google Sheets config found in Firebase\n`;
                            message += `‚ùå The configuration was not saved properly\n`;
                        }
                        
                        alert(message);
                    }
                }, 2000);
            } else {
                alert('Test failed: ' + (result.error || 'Unknown error'));
            }
        } else {
            const errorText = await response.text();
            alert('Test request failed: HTTP ' + response.status + ' - ' + errorText);
        }
    } catch (error) {
        console.error('Test error:', error);
        alert('Test error: ' + error.message);
    }
}

async function checkDependencies() {
    try {
        const response = await fetch('/api/admin/logging/check-deps');
        if (response.ok) {
            const deps = await response.json();
            
            let message = 'üì¶ Dependency Status Check:\n\n';
            
            // Firebase status
            if (deps.firebase) {
                if (deps.firebase.available) {
                    message += `‚úÖ Firebase: Available (v${deps.firebase.version})\n`;
                } else {
                    message += `‚ùå Firebase: Not available - ${deps.firebase.error}\n`;
                }
            }
            
            // Google Sheets status
            if (deps.google_sheets) {
                if (deps.google_sheets.available) {
                    message += `‚úÖ Google Sheets: Available (gspread v${deps.google_sheets.gspread_version})\n`;
                } else {
                    message += `‚ùå Google Sheets: Not available - ${deps.google_sheets.error}\n`;
                    message += `   Install with: pip install gspread google-auth\n`;
                }
            }
            
            message += '\nüîß Conversation Logger Status:\n';
            if (deps.conversation_logger) {
                message += `Firebase Connected: ${deps.conversation_logger.firebase_connected}\n`;
                message += `Sheets Logger Exists: ${deps.conversation_logger.sheets_logger_exists}\n`;
                message += `Sheets Connected: ${deps.conversation_logger.sheets_connected}\n`;
            }
            
            alert(message);
        } else {
            const errorText = await response.text();
            alert('Dependencies check failed: HTTP ' + response.status + ' - ' + errorText);
        }
    } catch (error) {
        console.error('Dependencies check error:', error);
        alert('Dependencies check error: ' + error.message);
    }
}

// Start logging monitoring
initializeLoggingMonitoring();
</script>
{% endblock %}